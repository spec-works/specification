name: Update xRegistry

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      commit_message:
        description: 'Custom commit message (optional)'
        required: false
        default: 'Update xRegistry catalog'
  
  # Scheduled weekly on Sundays at 2am UTC
  schedule:
    - cron: '0 2 * * 0'
  
  # Trigger when specs.json files change in any part repo
  repository_dispatch:
    types: [specs-updated]

permissions:
  contents: write

jobs:
  update-registry:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout specification repo
        uses: actions/checkout@v4
        with:
          repository: spec-works/specification
          path: specification
      
      - name: Checkout github.io repo
        uses: actions/checkout@v4
        with:
          repository: spec-works/spec-works.github.io
          token: ${{ secrets.GITHUB_TOKEN }}
          path: spec-works.github.io
      
      - name: Checkout part repositories
        run: |
          cd ${{ github.workspace }}
          git clone --depth 1 https://github.com/spec-works/vCard.git
          git clone --depth 1 https://github.com/spec-works/JsonDiff.git
          git clone --depth 1 https://github.com/spec-works/iCalendar.git
          git clone --depth 1 https://github.com/spec-works/MarkMyWord.git
          git clone --depth 1 https://github.com/spec-works/RateLimiter.git
          git clone --depth 1 https://github.com/spec-works/linkset.git
      
      - name: Generate registry
        shell: pwsh
        run: |
          cd ${{ github.workspace }}/specification/tools
          ./generate-registry.ps1 -SourceRoot ${{ github.workspace }} -OutputPath ${{ github.workspace }}/spec-works.github.io/registry
      
      - name: Check for changes
        id: check_changes
        run: |
          cd ${{ github.workspace }}/spec-works.github.io
          if [[ -n $(git status --porcelain registry/) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Registry has changes to commit"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes to registry"
          fi
      
      - name: Commit and push changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          cd ${{ github.workspace }}/spec-works.github.io
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add registry/
          
          COMMIT_MSG="${{ github.event.inputs.commit_message }}"
          if [ -z "$COMMIT_MSG" ]; then
            COMMIT_MSG="Update xRegistry catalog (automated)"
          fi
          
          git commit -m "$COMMIT_MSG" -m "Generated by: specification/tools/generate-registry.ps1" -m "Trigger: ${{ github.event_name }}" -m "Parts updated: $(cd ${{ github.workspace }} && ls -d */ | grep -v 'specification\|spec-works.github.io' | tr '\n' ', ' | sed 's/,$//')"
          git push
      
      - name: Summary
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          echo "✅ Registry updated successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Registry deployed to: https://spec-works.github.io/registry/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Changed files:**" >> $GITHUB_STEP_SUMMARY
          cd ${{ github.workspace }}/spec-works.github.io
          git diff HEAD~1 --name-only registry/ | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
      
      - name: No changes summary
        if: steps.check_changes.outputs.changes == 'false'
        run: |
          echo "ℹ️ No changes to registry" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All part specs.json files are up to date." >> $GITHUB_STEP_SUMMARY
